# Research Brief Publisher Service

This service publishes AI-generated research briefs to your Telegram channel.

## Features

- ðŸ“Š Publishes research briefs with stock data
- ðŸ“° Includes top news articles with AI analysis
- ðŸ’¹ Shows price movements, market cap, P/E ratios
- ðŸŽ¯ Sentiment indicators (ðŸŸ¢ Positive, ðŸ”´ Negative, âšª Neutral)
- â° Runs every 30 minutes (configurable)
- ðŸ”„ Prevents duplicate publishing via tracking table

## How It Works

1. **Fetches Unpublished Briefs**: Queries `research_briefs` table for briefs not yet published
2. **Formats for Telegram**: Creates rich HTML-formatted messages with:
   - Company name and symbol
   - Stock price and % change
   - Market cap, P/E ratio, 52-week range
   - Top 3 news articles with AI analysis
   - Sentiment indicators
3. **Publishes to Telegram**: Sends to configured channel
4. **Tracks Publishing**: Marks briefs as published in `research_briefs_published` table

## Message Format

```
ðŸ” Research Brief: Apple Inc (AAPL)
ðŸ“… November 18, 2025
ðŸ“Š 8 articles analyzed

ðŸ“Š Market Data
   Price: $189.50 ðŸ“ˆ +2.30%
   Market Cap: $2.95T
   P/E Ratio: 31.20
   52W Range: $164.08 - $199.62

ðŸ“° Recent News

ðŸŸ¢ 1. Apple Announces New AI Features in iPhone
   â€¢ New AI capabilities integrated into iOS
   â€¢ Expected to drive revenue growth in Q4
   Read more

âšª 2. Apple Supply Chain Updates in China
   â€¢ Manufacturing partners increasing capacity
   â€¢ Production timeline remains on track
   Read more

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Generated by Arth360 Research
â° 02:30 PM
```

## Configuration

### Environment Variables (in `.env`)

```env
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHANNEL_ID=@your_channel
DB_HOST=mysql
DB_USER=rss_user
DB_PASSWORD=your_password
DB_NAME=rss_reader
```

### Publishing Interval

Edit `research_telegram_publisher.py` line 382:

```python
# Every 30 minutes
publisher.run(interval=1800)

# Or hourly
publisher.run(interval=3600)

# Or every 2 hours
publisher.run(interval=7200)
```

## Database Schema

### `research_briefs_published` Table

```sql
CREATE TABLE research_briefs_published (
    id INT AUTO_INCREMENT PRIMARY KEY,
    brief_id INT NOT NULL,
    published_at DATETIME NOT NULL,
    FOREIGN KEY (brief_id) REFERENCES research_briefs(id),
    UNIQUE KEY unique_brief (brief_id)
);
```

## Running the Service

### With Docker (Recommended)

```bash
# Build and start
docker-compose up -d research-publisher

# View logs
docker-compose logs -f research-publisher

# Restart service
docker-compose restart research-publisher
```

### Standalone (for testing)

```bash
cd research-publisher
python3 -m venv venv
source venv/bin/activate
pip install -r ../requirements.txt

export DB_HOST=localhost
export DB_USER=root
export DB_PASSWORD=your_password
export DB_NAME=rss_reader
export TELEGRAM_BOT_TOKEN=your_token
export TELEGRAM_CHANNEL_ID=@your_channel

python research_telegram_publisher.py
```

## Testing

### 1. Check for Unpublished Briefs

```sql
SELECT
    rb.id, rb.company_symbol, rb.brief_date,
    rb.articles_analyzed, rb.generated_at
FROM research_briefs rb
LEFT JOIN research_briefs_published rbp ON rb.id = rbp.brief_id
WHERE rbp.brief_id IS NULL
    AND rb.articles_analyzed > 0
ORDER BY rb.generated_at DESC;
```

### 2. Manually Trigger Publishing

```bash
# Enter the container
docker exec -it arth360-research-publisher bash

# Run the publisher once
python research_telegram_publisher.py
# Press Ctrl+C after first cycle completes
```

### 3. Verify Publishing

```sql
-- Check published briefs
SELECT
    rbp.*, rb.company_symbol, rb.brief_date
FROM research_briefs_published rbp
JOIN research_briefs rb ON rbp.brief_id = rb.id
ORDER BY rbp.published_at DESC
LIMIT 10;
```

### 4. Reset for Re-testing

```sql
-- Clear published tracking (will republish all briefs)
TRUNCATE TABLE research_briefs_published;
```

## Logs

Logs are stored in `research-publisher/logs/`:
- **research_publisher.log**: Main log file
- Rotates daily at midnight
- Keeps 7 days of history

View logs:
```bash
# Docker logs (real-time)
docker-compose logs -f research-publisher

# File logs (inside container)
docker exec arth360-research-publisher tail -f /app/logs/research_publisher.log
```

## Troubleshooting

### No briefs being published

1. Check if research briefs exist:
```sql
SELECT COUNT(*) FROM research_briefs WHERE articles_analyzed > 0;
```

2. Check if they're already published:
```sql
SELECT COUNT(*) FROM research_briefs_published;
```

3. Verify user watchlist exists:
```sql
SELECT * FROM user_watchlist;
```

### Telegram errors

1. Test bot token:
```bash
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getMe"
```

2. Check channel ID format (should be `@channelname` or `-100123456789`)

3. Ensure bot is admin in channel

### Database connection issues

```bash
# Check if MySQL is running
docker-compose ps mysql

# Test connection
docker exec arth360-research-publisher python -c "
import mysql.connector
conn = mysql.connector.connect(
    host='mysql',
    user='rss_user',
    password='10_Leomessi',
    database='rss_reader'
)
print('Connected!')
conn.close()
"
```

## Service Dependencies

- **Requires**: `research` service to generate briefs first
- **Requires**: MySQL database with `research_briefs` table populated
- **Requires**: Telegram bot with channel admin access
- **Optional**: Can run independently of other publishers

## Customization

### Change Message Format

Edit `format_brief_message()` in [research_telegram_publisher.py](research_telegram_publisher.py#L227)

### Change Number of Articles Shown

Edit `format_news_summary()` line 215:
```python
for idx, article in enumerate(news_summary[:3], 1):  # Change :3 to :5 for 5 articles
```

### Add Company Logo/Image

Modify `send_to_telegram()` to use `sendPhoto` instead of `sendMessage`:
```python
# Fetch company logo from API
logo_url = f"https://logo.clearbit.com/{symbol.lower()}.com"

response = requests.post(
    f"https://api.telegram.org/bot{self.telegram_token}/sendPhoto",
    json={
        'chat_id': self.channel_id,
        'photo': logo_url,
        'caption': message,
        'parse_mode': 'HTML'
    }
)
```

## Performance

- **Publishes**: 1 brief per 5 seconds (rate limiting)
- **Query Time**: <100ms for unpublished briefs
- **Memory Usage**: ~50MB
- **CPU Usage**: <5% during publishing

## License

MIT License - Part of Arth360 project
